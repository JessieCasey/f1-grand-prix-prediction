from __future__ import annotations

import argparse
from pathlib import Path
from typing import Iterable

from src.core.reporting import (
    DEFAULT_RESULTS_PATH,
    DEFAULT_TOP_N,
    PredictionReporter,
    ReportConfig,
)


def build_arg_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(
        description="Summarise F1 prediction results generated by f1_grand_prix_predictor."
    )
    parser.add_argument(
        "--file",
        default=str(DEFAULT_RESULTS_PATH),
        help=f"Path to prediction CSV (default: {DEFAULT_RESULTS_PATH}).",
    )
    parser.add_argument(
        "--top",
        type=int,
        default=DEFAULT_TOP_N,
        help=f"How many rows per race to display (default: {DEFAULT_TOP_N}).",
    )
    return parser


def main(argv: Iterable[str] | None = None) -> int:
    parser = build_arg_parser()
    args = parser.parse_args(argv)

    try:
        reporter = PredictionReporter(
            ReportConfig(
                csv_path=Path(args.file),
                top_n=args.top,
            )
        )
        summary = reporter.run()
    except Exception as exc:  # noqa: BLE001
        print(f"Failed to build prediction report: {exc}")
        return 1

    print(summary)
    return 0


if __name__ == "__main__":
    main()
